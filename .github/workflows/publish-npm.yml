name: Publish to NPM

on:
  workflow_call:
    inputs:
      build-command:
        description: 'Command to build packages (default: bun run build)'
        type: string
        default: 'bun run build'
      version-command:
        description: 'Command to update package versions (default: bun run version-packages)'
        type: string
        default: 'bun run version-packages'
      publish-command:
        description: 'Command to publish packages (default: bun run release)'
        type: string
        default: 'bun run release'
      skip-build:
        description: 'Skip the build step (default: false)'
        type: boolean
        default: false
      bun-version:
        description: 'Bun version to use (default: latest)'
        type: string
        default: 'latest'
    secrets:
      NPM_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ inputs.bun-version }}

      - name: Install Dependencies
        run: bun install

      - name: Build Packages
        if: ${{ !inputs.skip-build }}
        run: ${{ inputs.build-command }}

      - name: Resolve workspace dependencies
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const { glob } = require('glob');

          // Read workspace config from root package.json
          const rootPkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          let workspacePatterns = rootPkg.workspaces || [];

          // Handle both array and object formats
          if (typeof workspacePatterns === 'object' && !Array.isArray(workspacePatterns)) {
            workspacePatterns = workspacePatterns.packages || [];
          }

          if (workspacePatterns.length === 0) {
            console.log('No workspaces configured, skipping...');
            process.exit(0);
          }

          console.log('Workspace patterns:', workspacePatterns);

          // Find all package.json files in workspace
          const packagePaths = [];
          workspacePatterns.forEach(pattern => {
            const matches = glob.sync(path.join(pattern, 'package.json'));
            packagePaths.push(...matches);
          });

          console.log('Found', packagePaths.length, 'packages');

          // Build version map
          const packages = new Map();
          packagePaths.forEach(pkgPath => {
            const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
            if (pkg.name && pkg.version) {
              packages.set(pkg.name, pkg.version);
              console.log(' -', pkg.name + '@' + pkg.version);
            }
          });

          // Resolve workspace deps
          let modified = 0;
          packagePaths.forEach(pkgPath => {
            const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
            let changed = false;

            ['dependencies', 'devDependencies', 'peerDependencies'].forEach(type => {
              if (!pkg[type]) return;

              Object.entries(pkg[type]).forEach(([name, version]) => {
                if (version.startsWith('workspace:')) {
                  const targetVer = packages.get(name);
                  if (targetVer) {
                    const newVer = version === 'workspace:*' ? targetVer :
                                   version === 'workspace:^' ? '^' + targetVer :
                                   version === 'workspace:~' ? '~' + targetVer :
                                   version.replace('workspace:', '');
                    console.log('Resolving', name + ':', version, '->', newVer, 'in', pkgPath);
                    pkg[type][name] = newVer;
                    changed = true;
                  }
                }
              });
            });

            if (changed) {
              fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
              modified++;
              console.log('âœ“ Updated', pkgPath);
            }
          });

          console.log('\\nResolved workspace dependencies in', modified, 'package(s)');
          "
        shell: bash

      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          version: ${{ inputs.version-command }}
          publish: ${{ inputs.publish-command }}
          commit: "chore(release): version packages"
          title: "chore(release): version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
