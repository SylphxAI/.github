name: Publish to NPM

on:
  workflow_call:
    inputs:
      # ========== Build Configuration ==========
      build-command:
        description: 'Command to build packages (default: bun run build)'
        type: string
        default: 'bun run build'
      skip-build:
        description: 'Skip the build step (default: false)'
        type: boolean
        default: false
      test-command:
        description: 'Command to run tests before publishing (optional)'
        type: string
        default: ''

      # ========== Version & Publish Configuration ==========
      version-command:
        description: 'Command to update package versions (default: bun run version-packages)'
        type: string
        default: 'bun run version-packages'
      publish-command:
        description: 'Command to publish packages (default: bun run release)'
        type: string
        default: 'bun run release'

      # ========== Multi-platform Support ==========
      download-artifacts:
        description: 'Download build artifacts before publishing (default: false)'
        type: boolean
        default: false
      artifacts-path:
        description: 'Path to download artifacts to (default: artifacts)'
        type: string
        default: 'artifacts'
      pre-publish-command:
        description: 'Command to run before @changesets/action (e.g., create platform packages)'
        type: string
        default: ''
      post-publish-command:
        description: 'Command to run after successful publish'
        type: string
        default: ''

      # ========== Runtime Configuration ==========
      bun-version:
        description: 'Bun version to use (default: latest)'
        type: string
        default: 'latest'
      node-version:
        description: 'Node.js version to use (default: 20)'
        type: string
        default: '20'

      # ========== Registry Configuration ==========
      npm-registry:
        description: 'NPM registry URL (default: https://registry.npmjs.org)'
        type: string
        default: 'https://registry.npmjs.org'

      # ========== Release Configuration ==========
      create-github-releases:
        description: 'Create GitHub releases (default: true)'
        type: boolean
        default: true

      # ========== Advanced Options ==========
      working-directory:
        description: 'Working directory for commands (default: .)'
        type: string
        default: '.'
      slack-webhook:
        description: 'Slack webhook URL for notifications. If not provided, falls back to SLACK_WEBHOOK secret. Leave empty to disable notifications.'
        type: string
        default: ''

    secrets:
      NPM_TOKEN:
        required: true
      SLACK_WEBHOOK:
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ inputs.bun-version }}

      - name: Install Dependencies
        run: bun install
        working-directory: ${{ inputs.working-directory }}

      - name: Download build artifacts
        if: ${{ inputs.download-artifacts }}
        uses: actions/download-artifact@v4
        with:
          path: ${{ inputs.artifacts-path }}

      - name: Build Packages
        if: ${{ !inputs.skip-build }}
        run: ${{ inputs.build-command }}
        working-directory: ${{ inputs.working-directory }}

      - name: Run Tests
        if: ${{ inputs.test-command != '' }}
        run: ${{ inputs.test-command }}
        working-directory: ${{ inputs.working-directory }}

      - name: Pre-publish setup
        if: ${{ inputs.pre-publish-command != '' }}
        run: ${{ inputs.pre-publish-command }}
        working-directory: ${{ inputs.working-directory }}

      - name: Update lockfile for workspace resolution
        run: bun install --no-save
        working-directory: ${{ inputs.working-directory }}

      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: ${{ inputs.npm-registry }}

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          version: ${{ inputs.version-command }}
          publish: ${{ inputs.publish-command }}
          commit: "chore(release): version packages"
          title: "chore(release): version packages"
          createGithubReleases: ${{ inputs.create-github-releases }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Post-publish actions
        if: ${{ inputs.post-publish-command != '' && (steps.changesets.outputs.published == 'true' || steps.changesets.conclusion == 'success') }}
        run: ${{ inputs.post-publish-command }}
        working-directory: ${{ inputs.working-directory }}

      - name: Notify Slack on publish
        if: ${{ steps.changesets.conclusion == 'success' }}
        run: |
          WEBHOOK="${{ inputs.slack-webhook }}"
          if [ -z "$WEBHOOK" ]; then
            WEBHOOK="${{ secrets.SLACK_WEBHOOK }}"
          fi

          if [ -n "$WEBHOOK" ]; then
            PACKAGE_NAME=$(node -p "try { require('./package.json').name } catch { 'unknown' }" 2>/dev/null || echo "unknown")
            VERSION=$(node -p "try { require('./package.json').version } catch { 'unknown' }" 2>/dev/null || echo "unknown")
            REPO="${{ github.repository }}"
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            # Try to extract published packages from changesets output
            PUBLISHED_PACKAGES="${{ steps.changesets.outputs.publishedPackages }}"

            MESSAGE="üì¶ *Published to npm*\n"
            MESSAGE="${MESSAGE}Repository: ${REPO}\n"
            MESSAGE="${MESSAGE}\n"

            # Check if changesets provided published packages info
            if [ -n "$PUBLISHED_PACKAGES" ] && [ "$PUBLISHED_PACKAGES" != "[]" ]; then
              # Parse the JSON array from changesets - use env var to avoid shell escaping issues
              PACKAGES=$(PKGS="$PUBLISHED_PACKAGES" node -e "try{JSON.parse(process.env.PKGS).forEach(p=>console.log(\\\`‚Ä¢ <https://www.npmjs.com/package/\${p.name}/v/\${p.version}|\\\\\\\`\${p.name}@\${p.version}\\\\\\\`>\\\`))}catch(e){console.error('Parse error:',e.message);process.exit(1)}" 2>&1 || true)

              if [ -n "$PACKAGES" ]; then
                MESSAGE="${MESSAGE}${PACKAGES}\n"
              else
                # Fallback to main package
                MESSAGE="${MESSAGE}‚Ä¢ <https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION}|\`${PACKAGE_NAME}@${VERSION}\`>\n"
              fi
            else
              # No changesets output - try to detect from workspace or just use main package
              # Check if there are npm/ directories (platform packages pattern)
              if [ -d "npm" ] && [ "$(find npm -maxdepth 1 -type d | wc -l)" -gt 1 ]; then
                # Found platform packages
                MESSAGE="${MESSAGE}‚Ä¢ <https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION}|\`${PACKAGE_NAME}@${VERSION}\`> (main)\n"
                for dir in npm/*/; do
                  if [ -f "${dir}package.json" ]; then
                    PKG_NAME=$(node -p "require('./${dir}package.json').name" 2>/dev/null || echo "")
                    if [ -n "$PKG_NAME" ]; then
                      MESSAGE="${MESSAGE}‚Ä¢ <https://www.npmjs.com/package/${PKG_NAME}/v/${VERSION}|\`${PKG_NAME}@${VERSION}\`>\n"
                    fi
                  fi
                done
              else
                # Just main package
                MESSAGE="${MESSAGE}‚Ä¢ <https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION}|\`${PACKAGE_NAME}@${VERSION}\`>\n"
              fi
            fi

            MESSAGE="${MESSAGE}\n"
            MESSAGE="${MESSAGE}<${RUN_URL}|View Workflow>"

            curl -X POST "$WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d "{\"text\":\"${MESSAGE}\"}"
          fi

      - name: Notify Slack on failure
        if: ${{ failure() }}
        run: |
          WEBHOOK="${{ inputs.slack-webhook }}"
          if [ -z "$WEBHOOK" ]; then
            WEBHOOK="${{ secrets.SLACK_WEBHOOK }}"
          fi

          if [ -n "$WEBHOOK" ]; then
            REPO="${{ github.repository }}"
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            BRANCH="${{ github.ref_name }}"

            MESSAGE="‚ùå *Publish workflow failed*\n"
            MESSAGE="${MESSAGE}Repository: ${REPO}\n"
            MESSAGE="${MESSAGE}Branch: ${BRANCH}\n"
            MESSAGE="${MESSAGE}Workflow: ${RUN_URL}"

            curl -X POST "$WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d "{\"text\":\"${MESSAGE}\"}"
          fi
