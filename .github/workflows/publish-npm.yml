name: Publish to NPM

on:
  workflow_call:
    inputs:
      build-command:
        description: 'Command to build packages (default: bun run build)'
        type: string
        default: 'bun run build'
      version-command:
        description: 'Command to update package versions (default: bun run version-packages)'
        type: string
        default: 'bun run version-packages'
      publish-command:
        description: 'Command to publish packages (default: bun run release)'
        type: string
        default: 'bun run release'
      skip-build:
        description: 'Skip the build step (default: false)'
        type: boolean
        default: false
      bun-version:
        description: 'Bun version to use (default: latest)'
        type: string
        default: 'latest'
    secrets:
      NPM_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ inputs.bun-version }}

      - name: Install Dependencies
        run: bun install

      - name: Build Packages
        if: ${{ !inputs.skip-build }}
        run: ${{ inputs.build-command }}

      - name: Update lockfile after version bump
        run: bun install --no-save

      - name: Resolve workspace dependencies (fallback for changesets)
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          // Read workspace config from root package.json
          const rootPkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          let workspacePatterns = rootPkg.workspaces || [];

          // Handle both array and object formats
          if (typeof workspacePatterns === 'object' && !Array.isArray(workspacePatterns)) {
            workspacePatterns = workspacePatterns.packages || [];
          }

          if (workspacePatterns.length === 0) {
            console.log('No workspaces configured, skipping...');
            process.exit(0);
          }

          console.log('Workspace patterns:', workspacePatterns);

          // Simple glob implementation for packages/*
          function findPackages(patterns) {
            const results = [];
            patterns.forEach(pattern => {
              // Handle patterns like 'packages/*'
              const parts = pattern.split('/');
              if (parts[parts.length - 1] === '*') {
                const dir = parts.slice(0, -1).join('/');
                if (fs.existsSync(dir)) {
                  fs.readdirSync(dir).forEach(entry => {
                    const pkgPath = path.join(dir, entry, 'package.json');
                    if (fs.existsSync(pkgPath)) {
                      results.push(pkgPath);
                    }
                  });
                }
              } else {
                // Direct path like 'docs'
                const pkgPath = path.join(pattern, 'package.json');
                if (fs.existsSync(pkgPath)) {
                  results.push(pkgPath);
                }
              }
            });
            return results;
          }

          const packagePaths = findPackages(workspacePatterns);
          console.log('Found', packagePaths.length, 'packages');

          // Build version map
          const packages = new Map();
          packagePaths.forEach(pkgPath => {
            const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
            if (pkg.name && pkg.version) {
              packages.set(pkg.name, pkg.version);
              console.log(' -', pkg.name + '@' + pkg.version);
            }
          });

          // Resolve workspace deps
          let modified = 0;
          packagePaths.forEach(pkgPath => {
            const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
            let changed = false;

            ['dependencies', 'devDependencies', 'peerDependencies'].forEach(type => {
              if (!pkg[type]) return;

              Object.entries(pkg[type]).forEach(([name, version]) => {
                if (version.startsWith('workspace:')) {
                  const targetVer = packages.get(name);
                  if (targetVer) {
                    const newVer = version === 'workspace:*' ? targetVer :
                                   version === 'workspace:^' ? '^' + targetVer :
                                   version === 'workspace:~' ? '~' + targetVer :
                                   version.replace('workspace:', '');
                    console.log('Resolving', name + ':', version, '->', newVer, 'in', pkgPath);
                    pkg[type][name] = newVer;
                    changed = true;
                  }
                }
              });
            });

            if (changed) {
              fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
              modified++;
              console.log('âœ“ Updated', pkgPath);
            }
          });

          console.log('\\nResolved workspace dependencies in', modified, 'package(s)');
          "
        shell: bash

      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          version: ${{ inputs.version-command }}
          publish: ${{ inputs.publish-command }}
          commit: "chore(release): version packages"
          title: "chore(release): version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
